/*
 * Copyright (c) 2020 The ZMK Contributors
 * SPDX-License-Identifier: MIT
 * 
 * Stenomi Keymap - Converted from QMK Georgi layout
 * This uses Plover HID mode for stenography with QWERTY fallback layers
 */

#include <dt-bindings/zmk/bt.h>
#include <behaviors.dtsi>
#include <dt-bindings/zmk/outputs.h>
#include <dt-bindings/zmk/keys.h>

#define PLOVER 0
#define QWERTY 1
#define SYMBOL 2
#define NUMBER 3
#define FUNCTION 4

/ {
    keymap {
        compatible = "zmk,keymap";

        // Layer 0: PLOVER/STENO - Main stenography layer
        // Use with Plover software in HID mode
        plover_layer {
// ┌──────────┬─────┬─────┬─────┬─────┬──────┐     ┌──────┬─────┬─────┬─────┬─────┬─────┐
// │ ->QWERTY │  S  │  T  │  P  │  H  │ ST1  │     │ ST3  │  F  │  P  │  L  │  T  │  D  │
// ├──────────┼─────┼─────┼─────┼─────┼──────┤     ├──────┼─────┼─────┼─────┼─────┼─────┤
// │  SYMBOL  │  S  │  K  │  W  │  R  │ ST2  │     │ ST4  │  R  │  B  │  G  │  S  │  Z  │
// └──────────┴─────┴─────┼─────┼─────┼──────┤     ├──────┼─────┼─────┼─────┴─────┴─────┘
//                         │  #  │  A  │  O   │     │  E   │  U  │  #  │
//                         └─────┴─────┴──────┘     └──────┴─────┴─────┘
            bindings = <
                &to QWERTY  &kp PLV_SL  &kp PLV_TL  &kp PLV_PL  &kp PLV_HL  &kp PLV_ST    &kp PLV_ST  &kp PLV_FR  &kp PLV_PR  &kp PLV_LR  &kp PLV_TR  &kp PLV_DR
                &mo SYMBOL  &kp PLV_SL  &kp PLV_KL  &kp PLV_WL  &kp PLV_RL  &kp PLV_ST    &kp PLV_ST  &kp PLV_RR  &kp PLV_BR  &kp PLV_GR  &kp PLV_SR  &kp PLV_ZR
                                                    &kp PLV_NM  &kp PLV_A   &kp PLV_O     &kp PLV_E   &kp PLV_U   &kp PLV_NM
            >;
        };

        // Layer 1: QWERTY - Fallback typing layer
        // Mimics the QMK layout structure
        qwerty_layer {
// ┌──────────┬─────┬─────┬─────┬─────┬──────┐     ┌──────┬─────┬─────┬─────┬─────┬──────┐
// │ ->PLOVER │  Q  │  W  │  E  │  R  │  T   │     │  Y   │  U  │  I  │  O  │  P  │ BSPC │
// ├──────────┼─────┼─────┼─────┼─────┼──────┤     ├──────┼─────┼─────┼─────┼─────┼──────┤
// │  SYMBOL  │  A  │  S  │  D  │  F  │  G   │     │  H   │  J  │  K  │  L  │  ;  │  '   │
// └──────────┴─────┴─────┼─────┼─────┼──────┤     ├──────┼─────┼─────┼─────┴─────┴──────┘
//                         │ NUM │ SPC │SHIFT │     │ ENT  │ SPC │ FN  │
//                         └─────┴─────┴──────┘     └──────┴─────┴─────┘
// Combos: A+S=Tab | J+K=Bspc | H+J=← | J+K=↓ | K+L=↑ | L+;=→
            bindings = <
                &to PLOVER  &kp Q  &kp W  &kp E      &kp R      &kp T         &kp Y      &kp U      &kp I      &kp O     &kp P      &kp BSPC
                &mo SYMBOL  &kp A  &kp S  &kp D      &kp F      &kp G         &kp H      &kp J      &kp K      &kp L     &kp SEMI   &kp SQT
                                          &mo NUMBER &kp SPACE  &kp LSHIFT    &kp ENTER  &kp SPACE  &mo FUNCTION
            >;
        };

        // Layer 2: SYMBOL - All symbols from PWR layer in QMK
        symbol_layer {
// ┌──────────┬─────┬─────┬─────┬─────┬──────┐     ┌──────┬─────┬─────┬─────┬─────┬──────┐
// │          │  !  │  @  │  {  │  }  │  |   │     │  '   │  +  │  -  │  /  │  *  │ TAB  │
// ├──────────┼─────┼─────┼─────┼─────┼──────┤     ├──────┼─────┼─────┼─────┼─────┼──────┤
// │  -----   │  #  │  $  │  (  │  )  │  `   │     │  "   │  &  │  =  │  ,  │  .  │ ESC  │
// └──────────┴─────┴─────┼─────┼─────┼──────┤     ├──────┼─────┼─────┼─────┴─────┴──────┘
//                         │     │     │      │     │  ;   │  \  │     │
//                         └─────┴─────┴──────┘     └──────┴─────┴─────┘
// Replaces QMK's PWR key combinations: PWR+key combos become direct access
            bindings = <
                &trans  &kp EXCL   &kp AT     &kp LBRC  &kp RBRC  &kp PIPE     &kp SQT    &kp PLUS   &kp MINUS  &kp FSLH   &kp STAR   &kp TAB
                &trans  &kp HASH   &kp DLLR   &kp LPAR  &kp RPAR  &kp GRAVE    &kp DQT    &kp AMPS   &kp EQUAL  &kp COMMA  &kp DOT    &kp ESC
                                              &trans    &trans    &trans       &kp SEMI   &kp BSLH   &trans
            >;
        };

        // Layer 3: NUMBER - Number row and navigation
        number_layer {
// ┌──────────┬─────┬─────┬─────┬─────┬──────┐     ┌──────┬─────┬─────┬─────┬─────┬──────┐
// │          │  1  │  2  │  3  │  4  │  5   │     │  6   │  7  │  8  │  9  │  0  │ BSPC │
// ├──────────┼─────┼─────┼─────┼─────┼──────┤     ├──────┼─────┼─────┼─────┼─────┼──────┤
// │          │  [  │  ]  │  {  │  }  │  `   │     │  ←   │  ↓  │  ↑  │  →  │  ~  │ ESC  │
// └──────────┴─────┴─────┼─────┼─────┼──────┤     ├──────┼─────┼─────┼─────┴─────┴──────┘
//                         │ --- │     │      │     │ ENT  │ TAB │     │
//                         └─────┴─────┴──────┘     └──────┴─────┴─────┘
// LNO/RNO keys from QMK - number access + navigation arrows on right
            bindings = <
                &trans  &kp N1    &kp N2    &kp N3    &kp N4     &kp N5       &kp N6     &kp N7     &kp N8    &kp N9     &kp N0     &kp BSPC
                &trans  &kp LBKT  &kp RBKT  &kp LBRC  &kp RBRC   &kp GRAVE    &kp LEFT   &kp DOWN   &kp UP    &kp RIGHT  &kp TILDE  &kp ESC
                                            &trans    &trans     &trans       &kp ENTER  &kp TAB    &trans
            >;
        };

        // Layer 4: FUNCTION - Function keys and media
        function_layer {
            bindings = <
                &trans  &kp F1     &kp F2     &kp F3     &kp F4     &kp F5       &kp F6     &kp F7     &kp F8     &kp F9     &kp F10    &kp F11
                &trans  &kp C_PREV &kp C_PP   &kp C_NEXT &kp C_VOL_DN &kp C_VOL_UP   &kp PG_UP  &kp PG_DN  &kp HOME   &kp END    &kp C_MUTE &kp F12
                                              &trans     &trans     &trans       &trans     &trans     &trans
            >;
        };
    };

    // COMBOS - Replicate QMK chord behavior
    // Key positions reference:
    //     0   1   2   3   4   5        6   7   8   9  10  11
    //    12  13  14  15  16  17       18  19  20  21  22  23
    //                24  25  26       27  28  29
    combos {
        compatible = "zmk,combos";

        // ═══════════════════════════════════════════════════════════════
        // SYSTEM COMBOS - Work on all layers
        // ═══════════════════════════════════════════════════════════════

        combo_bt_clear {
            timeout-ms = <50>;
            key-positions = <0 11>;  // Top corners: clear Bluetooth
            bindings = <&bt BT_CLR>;
        };

        combo_output_toggle {
            timeout-ms = <50>;
            key-positions = <1 10>;  // Second from corners: toggle USB/BT
            bindings = <&out OUT_TOG>;
        };

        // ═══════════════════════════════════════════════════════════════
        // QWERTY LAYER COMBOS - Replicate QMK thumb chords
        // ═══════════════════════════════════════════════════════════════

        // ───────────────────────────────────────────────────────────────
        // Thumb Combos - QMK: P( LA | LO, SEND(KC_LALT))
        // ───────────────────────────────────────────────────────────────

        combo_ctrl {
            timeout-ms = <30>;
            layers = <QWERTY>;
            key-positions = <24 25>;  // Left two thumbs = Ctrl
            bindings = <&kp LCTRL>;
        };

        combo_alt {
            timeout-ms = <30>;
            layers = <QWERTY>;
            key-positions = <25 26>;  // Middle thumbs = Alt
            bindings = <&kp LALT>;
        };

        combo_gui {
            timeout-ms = <30>;
            layers = <QWERTY>;
            key-positions = <26 27>;  // Right middle thumbs = GUI/Win
            bindings = <&kp LGUI>;
        };

        combo_esc {
            timeout-ms = <30>;
            layers = <QWERTY>;
            key-positions = <24 27>;  // Outer thumbs = Esc | QMK: P( LA | RU, SEND(KC_ESC))
            bindings = <&kp ESC>;
        };

        combo_caps {
            timeout-ms = <50>;
            layers = <QWERTY>;
            key-positions = <24 25 26 27>;  // All thumbs = Caps | QMK: P( LA | LO | RE | RU, SEND(KC_CAPS))
            bindings = <&kp CAPS>;
        };

        // ───────────────────────────────────────────────────────────────
        // Home Row Combos - QMK: P( LFT | LK, SEND(KC_S))
        // ───────────────────────────────────────────────────────────────

        combo_tab {
            timeout-ms = <30>;
            layers = <QWERTY>;
            key-positions = <13 14>;  // A + S = Tab
            bindings = <&kp TAB>;
        };

        combo_backspace {
            timeout-ms = <30>;
            layers = <QWERTY>;
            key-positions = <19 20>;  // J + K = Backspace
            bindings = <&kp BSPC>;
        };

        // ───────────────────────────────────────────────────────────────
        // Navigation - QMK MOVE layer: P( MOVE | RF, SEND(KC_LEFT))
        // ───────────────────────────────────────────────────────────────

        combo_left {
            timeout-ms = <50>;
            layers = <QWERTY>;
            key-positions = <18 19>;  // H + J = Left arrow
            bindings = <&kp LEFT>;
        };

        combo_down {
            timeout-ms = <50>;
            layers = <QWERTY>;
            key-positions = <19 20>;  // J + K = Down arrow
            bindings = <&kp DOWN>;
        };

        combo_up {
            timeout-ms = <50>;
            layers = <QWERTY>;
            key-positions = <20 21>;  // K + L = Up arrow
            bindings = <&kp UP>;
        };

        combo_right {
            timeout-ms = <50>;
            layers = <QWERTY>;
            key-positions = <21 22>;  // L + ; = Right arrow
            bindings = <&kp RIGHT>;
        };

        // ───────────────────────────────────────────────────────────────
        // Page Navigation
        // ───────────────────────────────────────────────────────────────

        combo_pgup {
            timeout-ms = <50>;
            layers = <QWERTY NUMBER>;
            key-positions = <10 11>;  // Top right corner = Page Up
            bindings = <&kp PG_UP>;
        };

        combo_pgdn {
            timeout-ms = <50>;
            layers = <QWERTY NUMBER>;
            key-positions = <22 23>;  // Bottom right corner = Page Down
            bindings = <&kp PG_DN>;
        };

        // ═══════════════════════════════════════════════════════════════
        // SYMBOL LAYER COMBOS - QMK: P( PWR | LP | LW, SEND(KC_LSFT); SEND(KC_9))
        // ═══════════════════════════════════════════════════════════════

        combo_bracket_left {
            timeout-ms = <30>;
            layers = <SYMBOL>;
            key-positions = <3 4>;  // { + } keys = [
            bindings = <&kp LBKT>;
        };

        combo_bracket_right {
            timeout-ms = <30>;
            layers = <SYMBOL>;
            key-positions = <4 5>;  // } + | keys = ]
            bindings = <&kp RBKT>;
        };

        combo_underscore {
            timeout-ms = <30>;
            layers = <SYMBOL>;
            key-positions = <8 9>;  // - + / = underscore
            bindings = <&kp UNDER>;
        };

        // ═══════════════════════════════════════════════════════════════
        // MOUSE EMULATION (Placeholders - ZMK doesn't support mouse)
        // QMK: P( LO | LSD | LK, CLICK_MOUSE(KC_MS_BTN2))
        // ═══════════════════════════════════════════════════════════════

        combo_mouse_left {
            timeout-ms = <50>;
            layers = <QWERTY>;
            key-positions = <14 15>;  // S + D (no mouse support in ZMK)
            bindings = <&kp SPACE>;   // Placeholder
        };

        combo_mouse_right {
            timeout-ms = <50>;
            layers = <QWERTY>;
            key-positions = <15 16>;  // D + F (no mouse support in ZMK)
            bindings = <&kp ENTER>;   // Placeholder
        };
    };
};
